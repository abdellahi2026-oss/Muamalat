
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the user has the 'admin' role.
     * It reads the user's role from their profile document in /users.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --------------------------------------------------------------------------------
    // User Profile Management
    // --------------------------------------------------------------------------------
    
    /**
     * @description Users can manage their own profiles. Admins can manage any user profile.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) || isAdmin(); // Allow admin to create users
      allow update: if isOwner(userId) || isAdmin(); // A user can update their own profile, or an admin can.
      allow list: if isAdmin(); // Only admins can list all users.
      allow delete: if false; // Disallow deletion of user profiles for data integrity.
    }

    // --------------------------------------------------------------------------------
    // User-Owned Data (Contracts)
    // --------------------------------------------------------------------------------

    /**
     * @description Secures all user-owned contracts (Murabaha, Mudarabah, Wakalah, Musharakah) in their respective subcollections.
     * @path /clients/{clientId}/{contractCollection}/{contractId}
     * @principle Enforces strict data ownership for all documents within a user's data tree.
     * A user can only read/write to their own subcollections.
     */
    match /clients/{clientId}/{contractCollection}/{contractId} {
        // Read Rule: Allow reading if the user is the owner of the client document.
        allow read: if isOwner(clientId);

        // Write Rule: Allow writing if the user is the owner AND the data being written has the correct clientId.
        // This prevents a user from creating a contract under their own ID but with another user's clientId field.
        allow write: if isOwner(clientId) && request.resource.data.clientId == clientId;
    }

    // --------------------------------------------------------------------------------
    // Public Reference Data (Read-Only for all signed-in users)
    // --------------------------------------------------------------------------------

    /**
     * @description Commodity cards are public reference data, readable by any signed-in user but not writable by clients.
     * @path /commodityCards/{commodityCardId}
     */
    match /commodityCards/{commodityCardId} {
      allow get, list: if isSignedIn();
      allow write: if false; 
    }

    /**
     * @description Agent information is public reference data.
     * @path /agents/{agentId}
     */
    match /agents/{agentId} {
      allow get, list: if isSignedIn();
      allow write: if false;
    }

    /**
     * @description Partner information is public reference data.
     * @path /partners/{partnerId}
     */
    match /partners/{partnerId} {
      allow get, list: if isSignedIn();
      allow write: if false;
    }
  }
}
