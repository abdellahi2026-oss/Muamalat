
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document exists before an update or delete operation.
     * This prevents operations on non-existent documents, which is a best practice.
     */
    function isExistingDoc() {
      return resource != null;
    }

    // --------------------------------------------------------------------------------
    // User Management
    // --------------------------------------------------------------------------------
    
    /**
     * @description Users can create and read their own profile. They cannot see other profiles.
     * @path /users/{userId}
     * @allow (read, create, update) A user managing their own profile.
     * @deny (list, delete) Listing or deleting profiles is not allowed for clients.
     */
    match /users/{userId} {
      allow read, create, update: if isOwner(userId);
      allow list, delete: if false;
    }
    
    // --------------------------------------------------------------------------------
    // Client & User-Owned Data
    // --------------------------------------------------------------------------------

    /**
     * @description A user can create and manage their own client profile.
     * @path /clients/{clientId}
     * @allow (read, write) A signed-in user managing their own document.
     * @deny (list) Listing all clients is forbidden to prevent user enumeration.
     */
    match /clients/{clientId} {
      allow read, write: if isOwner(clientId);
      allow list: if false;
    }

    /**
     * @description Secures all user-owned contracts (Murabaha, Mudarabah, Wakalah, Musharakah) in their respective subcollections.
     * @path /clients/{clientId}/{contractCollection}/{contractId}
     * @allow (read, write) The client creating/managing a contract in their own subcollection.
     * @deny (any) A user trying to access contracts under another client's path.
     * @principle Enforces strict data ownership for all documents within a user's data tree.
     */
    match /clients/{clientId}/{contractCollection}/{contractId} {
      allow read, list, write: if isOwner(clientId) && request.resource.data.clientId == clientId;
    }

    // --------------------------------------------------------------------------------
    // Public Reference Data (Read-Only)
    // --------------------------------------------------------------------------------

    /**
     * @description Commodity cards are public reference data, readable by anyone but not writable by clients.
     * @path /commodityCards/{commodityCardId}
     */
    match /commodityCards/{commodityCardId} {
      allow get, list: if isSignedIn();
      allow write: if false; 
    }

    /**
     * @description Agent information is public reference data.
     * @path /agents/{agentId}
     */
    match /agents/{agentId} {
      allow get, list: if isSignedIn();
      allow write: if false;
    }

    /**
     * @description Partner information is public reference data.
     * @path /partners/{partnerId}
     */
    match /partners/{partnerId} {
      allow get, list: if isSignedIn();
      allow write: if false;
    }
  }
}

    