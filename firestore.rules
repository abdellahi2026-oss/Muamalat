
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --------------------------------------------------------------------------------
    // User Profile Management
    // --------------------------------------------------------------------------------
    
    /**
     * @description Users can create and read their own profile. They cannot see other profiles or list all users.
     * @path /users/{userId}
     * @allow get - A user can read their OWN profile document.
     * @allow create - A user can create their own profile document.
     * @allow update - A user can update their own profile document.
     * @deny list, delete - Listing or deleting profiles is not allowed for clients.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow list, delete: if false;
    }

    // --------------------------------------------------------------------------------
    // User-Owned Data (Contracts)
    // --------------------------------------------------------------------------------

    /**
     * @description Secures all user-owned contracts (Murabaha, Mudarabah, Wakalah, Musharakah) in their respective subcollections.
     * @path /clients/{clientId}/{contractCollection}/{contractId}
     * @allow (read, write) The client creating/managing a contract in their own subcollection.
     * @deny (any) A user trying to access contracts under another client's path.
     * @principle Enforces strict data ownership for all documents within a user's data tree.
     */
    match /clients/{clientId}/{contractCollection}/{contractId} {
      allow read, list, write: if isOwner(clientId) && request.resource.data.clientId == clientId;
    }

    // --------------------------------------------------------------------------------
    // Public Reference Data (Read-Only for all signed-in users)
    // --------------------------------------------------------------------------------

    /**
     * @description Commodity cards are public reference data, readable by any signed-in user but not writable by clients.
     * @path /commodityCards/{commodityCardId}
     */
    match /commodityCards/{commodityCardId} {
      allow get, list: if isSignedIn();
      allow write: if false; 
    }

    /**
     * @description Agent information is public reference data.
     * @path /agents/{agentId}
     */
    match /agents/{agentId} {
      allow get, list: if isSignedIn();
      allow write: if false;
    }

    /**
     * @description Partner information is public reference data.
     * @path /partners/{partnerId}
     */
    match /partners/{partnerId} {
      allow get, list: if isSignedIn();
      allow write: if false;
    }
  }
}
